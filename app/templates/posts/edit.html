{% extends "base.html" %}
{% from "components/image_gallery.html" import image_gallery, image_upload_zone %}

{% block title %}Post bearbeiten - PostForge{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Post bearbeiten</h1>
    <p class="text-gray-600 mt-2">Bearbeiten Sie Ihren LinkedIn Post</p>
</div>

<div class="max-w-7xl mx-auto">
    <form method="POST" x-data="postEditor()">
        {{ form.hidden_tag() }}
        
        <div class="grid grid-cols-1 xl:grid-cols-3 lg:grid-cols-2 gap-8">
            <!-- Editor Section -->
            <div class="xl:col-span-2 space-y-6">
                <div class="card">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Post Details</h2>
                        
                        <div class="space-y-4">
                            <div>
                                {{ form.title.label(class="form-label") }}
                                {{ form.title(class="form-input", **{"x-model": "post.title"}) }}
                            </div>
                            
                            <div>
                                {{ form.content.label(class="form-label") }}
                                <div class="relative">
                                    {{ form.content(class="form-input", rows="8", **{"x-model": "post.content"}) }}
                                    <div class="absolute bottom-2 right-2 text-xs text-gray-500" 
                                         :class="{ 'text-yellow-600': charCount > 2500, 'text-red-600': charCount > 3000 }">
                                        <span x-text="charCount"></span>/3000
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                {{ form.hashtags.label(class="form-label") }}
                                {{ form.hashtags(class="form-input", placeholder="#linkedin #business #growth", **{"x-model": "post.hashtags"}) }}
                            </div>
                            
                            <div>
                                {{ form.notes.label(class="form-label") }}
                                {{ form.notes(class="form-input", rows="3", placeholder="Interne Notizen...", **{"x-model": "post.notes"}) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Einstellungen</h2>
                        
                        <div class="space-y-4">
                            <div>
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-input") }}
                            </div>
                            
                            <div>
                                {{ form.scheduled_date.label(class="form-label") }}
                                {{ form.scheduled_date(class="form-input") }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Image Upload Section -->
                <div class="card">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Bilder</h2>
                        
                        <div id="image-gallery-container" class="mb-6">
                            {% if post.images %}
                                {{ image_gallery(post.images, editable=true) }}
                            {% else %}
                                <div class="image-gallery" id="image-gallery"></div>
                            {% endif %}
                        </div>
                        
                        {{ image_upload_zone(post.id) }}
                    </div>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div class="space-y-6">
                <div class="card">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Vorschau</h2>
                        
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="mb-3">
                                <h3 class="font-semibold text-gray-900" x-text="post.title || 'Titel eingeben...'"></h3>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-gray-700 whitespace-pre-wrap" x-text="post.content || 'Inhalt eingeben...'"></p>
                            </div>
                            
                            <div x-show="post.hashtags">
                                <p class="text-blue-600 text-sm" x-text="post.hashtags"></p>
                            </div>
                            
                            {% if post.images %}
                                <div class="mt-4">
                                    <div class="grid grid-cols-2 gap-2">
                                        {% for image in post.images[:4] %}
                                            <img src="{{ url_for('static', filename='uploads/images/' + image.filename) }}" 
                                                 alt="{{ image.original_filename }}" 
                                                 class="w-full h-24 object-cover rounded">
                                        {% endfor %}
                                    </div>
                                    {% if post.images|length > 4 %}
                                        <p class="text-sm text-gray-500 mt-2">+{{ post.images|length - 4 }} weitere Bilder</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Post Actions -->
                <div class="card">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Aktionen</h2>
                        
                        <div class="space-y-3">
                            <button type="button" 
                                    onclick="copyToClipboard('{{ post.content|replace('\n', '\\n')|replace('\'', '\\\'') }}')"
                                    class="w-full btn-secondary">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                In Zwischenablage kopieren
                            </button>
                            
                            <a href="{{ url_for('posts.copy', id=post.id) }}" 
                               class="w-full btn-secondary block text-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                                </svg>
                                Post duplizieren
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="mt-8 flex justify-between">
            <a href="{{ url_for('posts.index') }}" class="btn-secondary">
                Zur√ºck zu Posts
            </a>
            
            <div class="space-x-4">
                {{ form.submit(class="btn-primary") }}
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function postEditor() {
    return {
        post: {
            title: '{{ post.title }}',
            content: `{{ post.content }}`,
            hashtags: '{{ post.hashtags or "" }}',
            notes: `{{ post.notes or "" }}`,
            scheduledDate: '{{ post.scheduled_date or "" }}'
        },
        charCount: 0,
        maxChars: 3000,
        
        init() {
            this.charCount = this.post.content.length;
            this.$watch('post.content', value => {
                this.charCount = value.length;
            });
        }
    }
}

function imageUpload(postId) {
    return {
        dragActive: false,
        uploading: false,
        
        handleDrop(event) {
            event.preventDefault();
            this.dragActive = false;
            const files = Array.from(event.dataTransfer.files);
            this.uploadImages(files);
        },
        
        handleFileSelect(event) {
            const files = Array.from(event.target.files);
            this.uploadImages(files);
        },
        
        uploadImages(files) {
            if (!files.length) return;
            
            this.uploading = true;
            const formData = new FormData();
            
            files.forEach(file => {
                formData.append('images', file);
            });
            
            if (postId) {
                formData.append('post_id', postId);
            }
            
            // Add CSRF token to form data
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                             document.querySelector('input[name="csrf_token"]')?.value;
            
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }
            
            // Use fetch instead of htmx.ajax for file uploads
            fetch('/upload/images', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                console.log('Upload response:', html);
                const container = document.getElementById('image-gallery-container');
                if (container) {
                    container.innerHTML = html;
                } else {
                    console.error('Container not found');
                }
                this.uploading = false;
            })
            .catch(error => {
                console.error('Upload error:', error);
                this.uploading = false;
            });
        }
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
        notification.textContent = 'In Zwischenablage kopiert!';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    });
}
</script>
{% endblock %}